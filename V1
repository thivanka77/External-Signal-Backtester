//@version=5
strategy("External Dual Signal Backtester", overlay=true)

// === Inputs ===
exitMode = input.string("Opposite Signal", "Exit Mode", options=["Opposite Signal","Fixed RR"])
slMode   = input.string("ATR", "Stop Loss Mode", options=["ATR","Candle Lookback"])
rrInput  = input.float(2.0,"Risk/Reward",step=0.1)
atrPeriod= input.int(14,"ATR Period")
atrMult  = input.float(2.0,"ATR Multiplier")
lookbackBars = input.int(5,"Candle Lookback Bars")

buySrc  = input.source(title="Buy Signal Source", defval=close)
sellSrc = input.source(title="Sell Signal Source", defval=close)

// === Signal Mapping ===
startLongTrade  = buySrc == 1
startShortTrade = sellSrc == 1

// === Variables to hold SL/TP ===
var float stopPrice  = na
var float targetPrice= na

// === Entry ===
if startLongTrade
    strategy.entry("Long", strategy.long)
    if exitMode == "Fixed RR"
        stopPrice  := slMode=="ATR" ? close - ta.atr(atrPeriod)*atrMult : open[lookbackBars]
        targetPrice:= close + (close - stopPrice)*rrInput
        strategy.exit("Long Exit","Long",stop=stopPrice,limit=targetPrice)

if startShortTrade
    strategy.entry("Short", strategy.short)
    if exitMode == "Fixed RR"
        stopPrice  := slMode=="ATR" ? close + ta.atr(atrPeriod)*atrMult : open[lookbackBars]
        targetPrice:= close - (stopPrice - close)*rrInput
        strategy.exit("Short Exit","Short",stop=stopPrice,limit=targetPrice)

// === Opposite Signal Exit Mode ===
if exitMode=="Opposite Signal"
    if sellSrc == 1 and strategy.position_size > 0
        strategy.close("Long")
    if buySrc == 1 and strategy.position_size < 0
        strategy.close("Short")


// ----------- Visual elements -------------- // 

// === TP and SL Plots ===
plot(stopPrice, "Stop Loss", color=color.red, style=plot.style_linebr)
plot(targetPrice, "Target", color=color.green, style=plot.style_linebr)


// === Results Table ===
var table results = table.new(position.top_right, 4, 2, border_width=1)

if barstate.isrealtime or barstate.islast
    trades   = strategy.closedtrades
    net      = strategy.netprofit
    winRate  = trades > 0 ? (strategy.wintrades * 100.0 / trades) : 0.0

    // Headers
    table.cell(results, 0, 0, "Trades",   text_color=color.white, bgcolor=color.black)
    table.cell(results, 1, 0, "Wins",     text_color=color.white, bgcolor=color.black)
    table.cell(results, 2, 0, "Losses",   text_color=color.white, bgcolor=color.black)
    table.cell(results, 3, 0, "Win Rate", text_color=color.white, bgcolor=color.black)

    // Values (forced to white text)
    table.cell(results, 0, 1, str.tostring(trades),   text_color=color.white)
    table.cell(results, 1, 1, str.tostring(strategy.wintrades), text_color=color.white)
    table.cell(results, 2, 1, str.tostring(strategy.losstrades), text_color=color.white)
    table.cell(results, 3, 1, str.tostring(winRate, "#.##") + "%", text_color=color.white)
